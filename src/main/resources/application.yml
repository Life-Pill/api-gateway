# LifePill API Gateway Configuration
#  API Gateway with Service Discovery,
# Circuit Breaker, and Centralized Configuration
# Start Order: Service Registry -> Config Server -> API Gateway

server:
  port: ${API_GATEWAY_PORT:9191}

spring:
  application:
    name: API-GATEWAY
  main:
    web-application-type: reactive
  
  # Redis for Rate Limiting (optional - disable if not using Redis)
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: ${REDIS_TIMEOUT:2000ms}
  
  # Spring Cloud Gateway Configuration
  cloud:
    gateway:
      # Enable service discovery
      discovery:
        locator:
          enabled: true
          lower-case-service-id: false
      
      # Default Filters applied to all routes
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - name: Retry
          args:
            retries: ${GATEWAY_RETRY_ATTEMPTS:3}
            statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
            methods: GET
            backoff:
              firstBackoff: ${GATEWAY_RETRY_FIRST_BACKOFF:50ms}
              maxBackoff: ${GATEWAY_RETRY_MAX_BACKOFF:500ms}
              factor: 2
              basedOnPreviousValue: false
      
      # Route Definitions
      routes:
        # User Authentication Service - Auth endpoints (versioned)
        - id: mobile-user-auth-service-auth
          uri: lb://${GATEWAY_USER_AUTH_SERVICE:MOBILE-USER-AUTH-SERVICE}
          predicates:
            - Path=/api/${API_VERSION:v1}/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: userAuthCircuitBreaker
                fallbackUri: forward:/fallback/auth
        
        # User Profile Service - User endpoints (versioned)
        - id: mobile-user-auth-service-user
          uri: lb://${GATEWAY_USER_AUTH_SERVICE:MOBILE-USER-AUTH-SERVICE}
          predicates:
            - Path=/api/${API_VERSION:v1}/user/**
          filters:
            - name: CircuitBreaker
              args:
                name: userAuthCircuitBreaker
                fallbackUri: forward:/fallback/user
        
        # OpenAPI Documentation
        - id: user-auth-api-docs
          uri: lb://${GATEWAY_USER_AUTH_SERVICE:MOBILE-USER-AUTH-SERVICE}
          predicates:
            - Path=/api/v3/api-docs/**,/api/swagger-ui/**,/api/swagger-ui.html

# API Versioning Configuration
api:
  version: ${API_VERSION:v1}

# Gateway Service Configuration
gateway:
  services:
    user-auth:
      name: ${GATEWAY_USER_AUTH_SERVICE:MOBILE-USER-AUTH-SERVICE}
    config-server:
      name: ${GATEWAY_CONFIG_SERVER:CONFIG-SERVER}
    eureka:
      uri: ${EUREKA_DASHBOARD_URI:http://localhost:8761}
  routes:
    auth-path: ${GATEWAY_AUTH_PATH:/api/${API_VERSION:v1}/auth/**}
    user-path: ${GATEWAY_USER_PATH:/api/${API_VERSION:v1}/user/**}
    retry-count: ${GATEWAY_ROUTES_RETRY_COUNT:3}
  headers:
    source: ${GATEWAY_HEADER_SOURCE:lifepill-gateway}

# Circuit Breaker Configuration (for Java Config)
circuitbreaker:
  default:
    sliding-window-size: ${CB_DEFAULT_SLIDING_WINDOW_SIZE:10}
    failure-rate-threshold: ${CB_DEFAULT_FAILURE_RATE_THRESHOLD:50}
    wait-duration-open-state: ${CB_DEFAULT_WAIT_DURATION_OPEN_STATE:10}
    permitted-calls-half-open: ${CB_DEFAULT_PERMITTED_CALLS_HALF_OPEN:5}
    slow-call-rate-threshold: ${CB_DEFAULT_SLOW_CALL_RATE_THRESHOLD:50}
    slow-call-duration-threshold: ${CB_DEFAULT_SLOW_CALL_DURATION_THRESHOLD:2}
    timeout-duration: ${CB_DEFAULT_TIMEOUT_DURATION:5}
  auth:
    sliding-window-size: ${CB_AUTH_SLIDING_WINDOW_SIZE:5}
    failure-rate-threshold: ${CB_AUTH_FAILURE_RATE_THRESHOLD:40}
    wait-duration-open-state: ${CB_AUTH_WAIT_DURATION_OPEN_STATE:15}
    permitted-calls-half-open: ${CB_AUTH_PERMITTED_CALLS_HALF_OPEN:3}
    slow-call-rate-threshold: ${CB_AUTH_SLOW_CALL_RATE_THRESHOLD:40}
    slow-call-duration-threshold: ${CB_AUTH_SLOW_CALL_DURATION_THRESHOLD:3}
    timeout-duration: ${CB_AUTH_TIMEOUT_DURATION:10}

# CORS Configuration - Externalized
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:8081}
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,PATCH,DELETE,OPTIONS}
  allowed-headers: ${CORS_ALLOWED_HEADERS:Authorization,Content-Type,Accept,Origin,X-Requested-With,X-XSRF-TOKEN,X-Gateway-Source}
  exposed-headers: ${CORS_EXPOSED_HEADERS:Authorization,X-Response-Time,X-Request-Id}
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  max-age: ${CORS_MAX_AGE:3600}

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URI:http://localhost:8761/eureka/}
    register-with-eureka: ${EUREKA_REGISTER:true}
    fetch-registry: ${EUREKA_FETCH_REGISTRY:true}
    registry-fetch-interval-seconds: ${EUREKA_FETCH_INTERVAL:30}
  instance:
    hostname: ${HOSTNAME:localhost}
    prefer-ip-address: ${EUREKA_PREFER_IP:true}
    instance-id: ${spring.application.name}:${server.port}:${random.value}
    lease-renewal-interval-in-seconds: ${EUREKA_LEASE_RENEWAL:30}
    lease-expiration-duration-in-seconds: ${EUREKA_LEASE_EXPIRATION:90}
    metadata-map:
      zone: ${ZONE:primary}
      profile: ${SPRING_PROFILES_ACTIVE:default}

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: ${CB_SLIDING_WINDOW_SIZE:10}
        failure-rate-threshold: ${CB_FAILURE_RATE_THRESHOLD:50}
        wait-duration-in-open-state: ${CB_WAIT_DURATION:10s}
        permitted-number-of-calls-in-half-open-state: ${CB_HALF_OPEN_CALLS:5}
        register-health-indicator: true
        automatic-transition-from-open-to-half-open-enabled: true
    instances:
      userAuthCircuitBreaker:
        base-config: default
        sliding-window-size: ${CB_AUTH_SLIDING_WINDOW_SIZE:5}
        failure-rate-threshold: ${CB_AUTH_FAILURE_RATE:40}
        wait-duration-in-open-state: ${CB_AUTH_WAIT_DURATION:15s}
      defaultCircuitBreaker:
        base-config: default
  
  timelimiter:
    configs:
      default:
        timeout-duration: ${TL_TIMEOUT:5s}
    instances:
      userAuthCircuitBreaker:
        timeout-duration: ${TL_AUTH_TIMEOUT:10s}

# Actuator Configuration for Production Monitoring
management:
  endpoints:
    web:
      exposure:
        include: ${ACTUATOR_ENDPOINTS:health,info,metrics,prometheus,gateway,circuitbreakers,circuitbreakerevents}
      base-path: /actuator
  endpoint:
    health:
      show-details: ${ACTUATOR_HEALTH_DETAILS:when_authorized}
      show-components: ${ACTUATOR_HEALTH_COMPONENTS:when_authorized}
      probes:
        enabled: true
    gateway:
      enabled: true
    info:
      enabled: true
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
    diskspace:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:development}
    distribution:
      percentiles-histogram:
        http.server.requests: true
        resilience4j.circuitbreaker.calls: true

# Application Info
info:
  app:
    name: ${INFO_APP_NAME:LifePill API Gateway}
    description: ${INFO_APP_DESC:Production-grade API Gateway for LifePill Microservices}
    version: ${INFO_APP_VERSION:v1.0.0}
    encoding: UTF-8
    java:
      version: ${java.version}

# Logging Configuration
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.lifepill: ${LOG_LEVEL_APP:DEBUG}
    org.springframework.cloud.gateway: ${LOG_LEVEL_GATEWAY:INFO}
    io.github.resilience4j: ${LOG_LEVEL_RESILIENCE:DEBUG}
    reactor.netty: ${LOG_LEVEL_NETTY:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ${LOG_PATH:./logs}/api-gateway.log